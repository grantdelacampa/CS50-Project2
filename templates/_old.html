<!--
/*
*
* Grant De La Campa
* 2020
* Project2
*
*/
-->
<!DOCTYPE html>
<html lang="en">
<head>
<title>CSS Website Layout</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://kit.fontawesome.com/3494d2530e.js" crossorigin="anonymous"></script>
<link rel="stylesheet" type="text/css" href="{{url_for('static', filename='main.css')}}">
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
<script type="text/javascript" charset="utf-8">

/*
	Outgoing
	Events and their ajax to server
*/
document.addEventListener('DOMContentLoaded', () => {
    var socket = io();
	
	socket.on('connect', () => {
	
		// set up the server and tell it what user has connected
		socket.emit('init', {'user': localStorage.getItem('username')});
		
		// Get the event that the user clicks confirm in the dialog box
		// and update that users username in the server and then locally
		document.getElementById('confirmBtn').addEventListener("click", function () {
		var input = document.getElementById('dialog-input');
		var box = document.getElementById('dialog-form');
		// check that the input is not empty or ""
		if(input.value.length > 0){
			// Set username to local storage
			let temp = localStorage.getItem('username');
			localStorage.setItem('username', input.value);
			// set the tag to the username 
			document.getElementById('nav-user').innerHTML = localStorage.getItem('username');
			// ajax call to server
			socket.emit('username_update', {'old': temp, 'user': input.value});
			// reset dialog and close box
			input.value = "";
			box.close();
		}
		});
		
		// get the event that the create button was pressed to create a new room
		document.getElementById('create-button').addEventListener("click", function() {
			var text = document.getElementById('room-input');
			if(text.value.length > 0){
				socket.emit('add_room', {'name': text.value});
			}
		});	
	});

/*-------------------------------------------------------------------------
	Incoming
	Events and their ajax from the server
--------------------------------------------------------------------------*/

	// process username update from server
	// notify the users in the room
	socket.on('notify', data=> {
		var dialog = document.getElementById('user-dialog');
		let notice = data.message;
		let div = document.createElement('div');
			div.className = 'container-notice';
		let text = document.createElement('p');
			text.innerHTML = notice;
			div.appendChild(text);
		document.getElementById('middle-col').appendChild(div);
	});
	
	// process add room from server
	// IMPORTANT: Initialize EventListeners here to ensure the room is in scope. 
	socket.on('addRoom', data => {
		let div = document.createElement('div');
			div.className = 'room-container';
			// The element has been created and now add a listener
			div.addEventListener('click', () => {
					let user = localStorage.getItem('username');
					// Notify the server that the user wants to join a room
					socket.emit('join', {'username': user, 'name': data.name});
			});
		let p = document.createElement('p');
			p.innerHTML = data.name;
		div.appendChild(p);
		document.getElementById('column-side').appendChild(div);
		document.getElementById('room-input').value = "";
		document.getElementById('new-room').style.display = "none";
	});
	
	// Update the clients room data to reflect the server
	// Erase current messages to "change room"
	socket.on('joinroom', data => {
		let name = data.room
		document.getElementById('room-name').innerHTML = name;
		const messages = document.getElementById('message-container');
		// Now go through the kids and delete them all 
		let notice = "Room changed";
		let div = document.createElement('div');
			div.className = 'container-notice';
		let text = document.createElement('p');
			text.innerHTML = notice;
			div.appendChild(text);
		document.getElementById('middle-col').appendChild(div);
	});
	
	// prevents double socket connection somehow
	socket.on('disconnect', function () {
        socket.removeAllListeners('send message');
        socket.removeAllListeners('disconnect');
        io.removeAllListeners('connection');
    });

});

</script>
</head>
<body>
<dialog id = "user-dialog">
	<div id="dialog-div">
		<form method = "dialog" id="dialog-form">
			<h1>JChatter</h1>
			<p id = "dialog-prompt">Welcome please choose a username.</p>
			<input id="dialog-input" type="text"></input>
			<button id="confirmBtn" value="default">Confirm</button>
		</form>
	</div>
</dialog>
<div class="navbar">
  <h2>JChatter</h2>
  <h4 id="nav-user"></h4>
</div>

<div class="row">
	<div class="column side" id = "column-side">
		<h2 id="dropper">Rooms <i id = "add-icon" class='fas fa-plus'></i></h2>
		<div class="room-container" id = "new-room">
			<input id="room-input"></input>
			<button id="create-button">Create</button>
		</div>
	</div>
  
	<div class="column middle" id = "column-middle">
		<h2 id = "room-name">Main Room</h2>
		<div id = "middle-col">
		</div>
		<div class="message-bar">
			<input id="input-button" class="input-button" type="submit" value="Send" />
			<div>
				<input id="text-field" class="text-field" type="text"/>
			</div>
		</div>
	</div>
</div>
<footer>
<script>
// All code located in the footer is indepedent of the server

// This only seems to work when placed in the footer
if(!localStorage.getItem('username')){
	// open the dialog box
	document.getElementById('user-dialog').show();
} else {
	// show the username in the nav bar
	document.getElementById('nav-user').innerHTML = localStorage.getItem('username');
}

// Get the event that the user clicks their username and open the dialog box
document.getElementById('nav-user').addEventListener("click", function () {
	document.getElementById('dialog-prompt').innerHTML = ('Select a new username or press confirm to go back');
	document.getElementById('dialog-input').value = localStorage.getItem('username');
	document.getElementById('user-dialog').show();
});

// get the event that the add icon was pressed to add a new room
document.getElementById('add-icon').addEventListener("click", function() {
	var icon = document.getElementById('new-room');
	if(icon.style.display === "none"){
		icon.style.display = "block";
	} else {
		icon.style.display = "none";
		document.getElementById('room-input').value = "";
	}
});

// get the event that the user pressed enter in the message input field
document.getElementById('text-field').addEventListener("keyup", function(event){
	if(event.key === "Enter"){
		document.getElementById('input-button').click();
	}
});
			
// get the event that the user presses enter in the room input field
document.getElementById('room-input').addEventListener("keyup", function(event){
	if(event.key === "Enter"){
		document.getElementById('create-button').click();
	}
});

// Get the event that the window was resized or loaded
window.addEventListener('resize', resize());
window.addEventListener('load', resize());
function resize() {
	var w = window.innerWidth;
	var h = window.innerHeight;
	var page_header_height = document.getElementById('nav').offsetHeight;
	var room_header_height = document.getElementById('room-name').offsetHeight;
	var adjusted_height = h - page_header_height - room_header_height;
	if ( w > 600) {
		adjusted_height += 'px';
		document.getElementById('column-middle').style.minHeight = adjusted_height;
		document.getElementById('column-side').style.minHeight = adjusted_height;
	} else {
		adjusted_height -= room_header_height;
		adjusted_height += 'px';
		document.getElementById('column-middle').style.minHeight = adjusted_height;
	}
}

// sets the interface to dark mode
function setDarkMode(){
	document.documentElement.style.setProperty('--main-bg-color', 'black');
	document.documentElement.style.setProperty('--secondary-bg-color', '#3a3f54');
	document.documentElement.style.setProperty('--accent-bg-color', 'blue');
	document.documentElement.style.setProperty('--text-color', 'white');
	document.documentElement.style.setProperty('--border-color', 'darkgrey');
	document.documentElement.style.setProperty('--local-message', '#424bf5');
	document.documentElement.style.setProperty('--server-message', 'green');
}

// sets the interface to light mode		
function setLightMode(){
	document.documentElement.style.setProperty('--main-bg-color', 'white');
	document.documentElement.style.setProperty('--secondary-bg-color', 'lightgrey');
	document.documentElement.style.setProperty('--accent-bg-color', 'blue');
	document.documentElement.style.setProperty('--text-color', 'black');
	document.documentElement.style.setProperty('--border-color', 'black');
	document.documentElement.style.setProperty('--local-message', 'skyblue');
	document.documentElement.style.setProperty('--server-message', 'lightgreen');
}
</script>
</footer>
</body>
</html>
